/*
    Data binding syntax inspired by Simon Mekonen
*/

// JSON Object bound to variable temp. TODO: remove hardcode, allow for iterance
var temp ={
  "gene": [
    {
      "end": 1623413,
      "geneId": "FBgn0035244",
      "geneName": "ABCB7",
      "start": 1618414,
      "transcripts": [
        {
          "end": 1623413,
          "exons": [
            {
              "end": 1618617,
              "exonId": "FBgn0035244:1",
              "exonNumber": "1",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1618617,
                  "start": 1618501,
                  "type": "CDS"
                },
                {
                  "end": 1618503,
                  "start": 1618501,
                  "type": "start_codon"
                }
              ],
              "start": 1618414
            },
            {
              "end": 1620554,
              "exonId": "FBgn0035244:2",
              "exonNumber": "2",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1620554,
                  "start": 1620428,
                  "type": "CDS"
                }
              ],
              "start": 1620428
            },
            {
              "end": 1621042,
              "exonId": "FBgn0035244:3",
              "exonNumber": "3",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1621042,
                  "start": 1620817,
                  "type": "CDS"
                }
              ],
              "start": 1620817
            },
            {
              "end": 1621257,
              "exonId": "FBgn0035244:5",
              "exonNumber": "4",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1621257,
                  "start": 1621103,
                  "type": "CDS"
                }
              ],
              "start": 1621103
            },
            {
              "end": 1622665,
              "exonId": "FBgn0035244:6",
              "exonNumber": "5",
              "exonVersion": "1",
              "ranges": [
                 {
                  "end": 1622665,
                  "start": 1621317,
                  "type": "CDS"
                }
              ],
              "start": 1621317
            },
            {
              "end": 1623413,
              "exonId": "FBgn0035244:8",
              "exonNumber": "6",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1622986,
                  "start": 1622732,
                  "type": "CDS"
                },
                {
                  "end": 1622989,
                  "start": 1622987,
                  "type": "stop_codon"
                }
              ],
              "start": 1622732
            }
          ],
          "ranges": [
            {
              "end": 1618500,
              "start": 1618414,
              "type": "UTR"
            },
            {
              "end": 1623413,
              "start": 1622990,
              "type": "UTR"
            }
          ],
          "start": 1618414,
          "transcriptId": "FBtr0072754",
          "transcriptName": "ABCB7-RA"
        },
        {
          "end": 1623159,
          "exons": [
            {
              "end": 1618617,
              "exonId": "FBgn0035244:1",
              "exonNumber": "1",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1618617,
                  "start": 1618501,
                  "type": "CDS"
                },
                {
                  "end": 1618503,
                  "start": 1618501,
                  "type": "start_codon"
                }
              ],
              "start": 1618414
            },
            {
              "end": 1620554,
              "exonId": "FBgn0035244:2",
              "exonNumber": "2",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1620554,
                  "start": 1620428,
                  "type": "CDS"
                }
              ],
              "start": 1620428
            },
            {
              "end": 1621042,
              "exonId": "FBgn0035244:4",
              "exonNumber": "3",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1621042,
                  "start": 1620919,
                  "type": "CDS"
                }
              ],
              "start": 1620919
            },
            {
              "end": 1621257,
              "exonId": "FBgn0035244:5",
              "exonNumber": "4",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1621257,
                  "start": 1621103,
                  "type": "CDS"
                }
              ],
              "start": 1621103
            },
            {
              "end": 1622665,
              "exonId": "FBgn0035244:6",
              "exonNumber": "5",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1622665,
                  "start": 1621317,
                  "type": "CDS"
                }
              ],
              "start": 1621317
            },
            {
              "end": 1623159,
              "exonId": "FBgn0035244:7",
              "exonNumber": "6",
              "exonVersion": "1",
              "ranges": [
                {
                  "end": 1622986,
                  "start": 1622732,
                  "type": "CDS"
                },
                {
                  "end": 1622989,
                  "start": 1622987,
                  "type": "stop_codon"
                }
              ],
              "start": 1622732
            }
          ],
          "ranges": [
            {
              "end": 1618500,
              "start": 1618414,
              "type": "UTR"
            },
            {
              "end": 1623159,
              "start": 1622990,
              "type": "UTR"
            }
          ],
          "start": 1618414,
          "transcriptId": "FBtr0072755",
          "transcriptName": "ABCB7-RB"
        }
      ]
    }
  ],
  "hits": [
    {
      "chromosome": "chr3L",
      "gene": [],
      "position": "1618414",
      "sequence": "CCATGCGAATGCTGATATCGTAGCAAAAACACAGGGACGGTGCGAAAGAAGAGGGATTTTATTTTGTTTTCGCCTGGCAATTGAGTAATGGCCGGACTCCTTCACCTGACCAAGCAGTGCAGCATCCACCTACCCGCCCACTTGGGACGCGCGAAATGCTACACACTCGCTAAGGGACCGGGAACACACGTGCAGGCAAGAGTG"
    }
  ],
  "query": "GAG"
}
  var ABCB7 = temp.gene[0];
  var query = temp.query;
  var sequence = temp.hits[0].sequence;
  var startIn = temp.hits[0].position;
  var canva= d3.select('#results').append('svg')
      .attr('width',1000)
      .attr('height', 75)
      .style('border', '3px solid');

  var transcriptline = canva.selectAll('g')
    .data(ABCB7.transcripts)
    .enter()
    .append('g');
  var transcripts = transcriptline.attr('transform', (d,i) => 'translate(0, '+40*i+')')
    .append('rect')
    .attr("x", 10)
    .attr("y", 15)
    .attr("width",function(d) { return d.end-d.start + 10})
    .attr("height", 5)
    .attr("fill","black");

  var transcriptName = transcriptline.append('text')
    .attr("x",10)
    .attr("y", 15)
    .text(function(d) {return d.transcriptName})
    .attr("font-size", "15px")
    .attr("fill", "black");
  var transcriptText = transcriptline.selectAll('g')
    .data(ABCB7.transcripts)
    .enter()
    .append('g');  
   var exons =  transcriptline.selectAll('g')
    .data(function(d,i) { return ABCB7.transcripts[i].exons})
    .enter()
    .append('g');

  var exons2 = exons.append('rect')
    .attr("x", function(d,i) {if(d.exonNumber==4) {
      return 80+d.end-d.start;
    }
    else {
      return 10 + d.end-d.start;
    }})
    .attr("y",0)
    .attr("width", function(d,i) {if(d.exonNumber==4) {
      return 3;
    }
    else {
      return 10 + d.end-d.start;
    }})
    .attr("height", 30)
    .attr("fill", "black");
    var start = exons.append('rect')
.attr("x", (ABCB7.transcripts[0].exons[0].ranges[0].start-ABCB7.transcripts[0].exons[0].start + 50))
.attr("y",0)
.attr("width", 3
)
.attr("height",30)
.attr("fill", "green");
    var indi = getIndicesOf(query,sequence);
    var clusters = canva.selectAll('g')
    .data([50,89,120])
    .enter()
    .append('g');
  for(var j=0;j<3;j++) {
  var clustexon = exons.append('rect')
  .attr("x", (indi[j]+10))
  .attr("y",0)
  .attr("width", 3
  )
  .attr("height",30)
  .attr("fill", "blue");
  }
  var start = transcriptline.selectAll('g')
    .data(function(d,i) {return ABCB7.transcripts[0].exons[0].ranges})
    .enter()
    .append('g');

  var startexon = start.append('rect')
    .attr("x",function(d,i){
         return 10+d.end - d.start})
    .attr("y",0)
    .attr("width",function(d,i){
      return 3;
    })
    .attr("height",30)
    .attr("fill",function(d,i) { if((d.type).equals("start_codon")) {
      return "green";
    }
  else {
    return "black";
  }});
/*   var lines = canva.append("line")
    .attr("x1",10)
    .attr("y1",)
    .attr("x2", function)
    .attr("y2",)

    
  group.selectAll(".line")
    .data(ABCB7.transcripts)
    .enter().append("path")
    .attr("class", "line")
    .attr("d", line); */
/*   for (var transcripts in ABCB7) {
    if(!ABCB7.hasOwnProperty(trancripts)) {
      continue;
    }
    canva.append.line()
      .x(function(d,i){transcripts.end-transcripts.start;})
      .y(function(d,i){
        return (50*i+100);
    });
  }
  */

  // Gives the summary info x from base pairs 
  //TODO : Appending to SVG
  function wildcard(searchString) {
    if (searchString.indexOf('M') != -1) {
      console.log(searchString.replace('M','A'));
      return getIndicesOf(searchString.replace('M','A'),sequence) + getIndicesOf(searchString.replace('M','C'),sequence);
      
    }
    if (searchString.indexOf('R') != -1) {
      console.log(searchString.replace('R','A'));
      return getIndicesOf(searchString.replace('R','A'),sequence) + getIndicesOf(searchString.replace('R','G'),sequence);
      
    }
    if (searchString.indexOf('Y') != -1) {
      console.log(searchString.replace('Y','T'));
      return getIndicesOf(searchString.replace('Y','C'),sequence) + getIndicesOf(searchString.replace('Y','T'),sequence);
      
    }
    if (searchString.indexOf('S') != -1) {
      console.log(searchString.replace('S','G'));
      return getIndicesOf(searchString.replace('S','G'),sequence) + getIndicesOf(searchString.replace('S','C'),sequence);
      
    }
    if (searchString.indexOf('W') != -1) {
      console.log(searchString.replace('W','A'));
      return getIndicesOf(searchString.replace('W','A'),sequence) + getIndicesOf(searchString.replace('W','T'),sequence);
      
    }
    if (searchString.indexOf('K') != -1) {
      console.log(searchString.replace('K','G'));
      return getIndicesOf(searchString.replace('K','G'),sequence) + getIndicesOf(searchString.replace('K','T'),sequence);
      
    }
    if (searchString.indexOf('B') != -1) {
      console.log(searchString.replace('B','C'));
      return getIndicesOf(searchString.replace('B','C'),sequence) + getIndicesOf(searchString.replace('B','G'),sequence)+getIndicesOf(searchString('B','T'),sequence);
      
    }
    if (searchString.indexOf('D') != -1) {
      console.log(searchString.replace('D','A'));
      return getIndicesOf(searchString.replace('D','A'),sequence) + getIndicesOf(searchString.replace('D','G'),sequence)+getIndicesOf(searchString('D','T'),sequence);
      
    }

  }
  function getIndicesOf(searchStr, str) {
    var searchStrLen = searchStr.length;
    if (searchStrLen == 0) {
        return [];
    }
    var startIndex = 0, index, indices = [];
        str = str.toLowerCase();
        searchStr = searchStr.toLowerCase();
    while ((index = str.indexOf(searchStr, startIndex)) > -1) {
        indices.push(index);
        startIndex = index + searchStrLen;
    }

    return indices;
}
console.log(indi);
query = "GAG";
var indi = getIndicesOf(query,sequence);
appendStats(indi);
function appendStats(data) {
  var mainContain3 = document.getElementById('results');

  for (var i=0;i<3;i++){
  var div = document.createElement("div");
  div.innerHTML = 'Cluster ' + (i+1) + 'is ' + (220-indi[i])+ "bp from the start codon" ;
  
  mainContain3.appendChild(div);
  }} 
   